<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 標題已更新 -->
    <title>佳里奇美醫院藥品材料申請系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Noto Sans TC字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .disabled-input {
            background-color: #f1f5f9;
            color: #64748b;
            cursor: not-allowed;
        }
        .request-card {
            transition: all 0.2s ease-in-out;
        }
        .request-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
            text-transform: uppercase;
        }
        .status-manager-approval { background-color: #e0e7ff; color: #3730a3; } /* 待單位主管簽核 */
        .status-manager-rejected { background-color: #FEF9C3; color: #713F12; } /* 主管退回 */
        .status-pending { background-color: #fef3c7; color: #92400e; } /* 待發料單位處理 */
        .status-dispatched { background-color: #d1fae5; color: #065f46; } /* 已發料 */
        .status-cancelled { background-color: #fee2e2; color: #991b1b; } /* 申請取消 */
        .status-rejected { background-color: #e5e7eb; color: #4b5563; } /* 無法發料 */

        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .animate-shake {
          animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes pulse-badge {
          50% { opacity: .6; }
        }
        .animate-pulse-badge {
          animation: pulse-badge 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .tab-btn {
            padding: 0.75rem 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }
        .tab-btn:hover {
            background-color: #f3f4f6;
        }
        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        /* 確保 datalist 選項可見 */
        datalist {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 99;
        }
        /* For item rows */
        .item-row {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #f9fafb;
        }
        
        /* ***** NEW: Admin Item Row Style ***** */
        .item-row-admin {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            background-color: #f9fafb;
        }
        
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="w-full max-w-5xl mx-auto p-4 sm:p-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">                
                <img src="logo.png" alt="奇美醫院Logo" class="h-12 w-12 sm:h-16 sm:w-16 object-contain rounded-lg" onerror="this.src='https://placehold.co/64x64/003366/FFFFFF?text=CCH&font=inter'; this.onerror=null;">
                <h1 class="text-xl sm:text-3xl font-bold text-gray-800">佳里奇美醫院 酒精/藥品申請系統</h1>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="flex flex-wrap border-b border-gray-200 bg-white rounded-t-lg">
            <button data-tab="apply" class="tab-btn active text-sm sm:text-base font-medium">填寫申請</button>
            <button data-tab="search" class="tab-btn text-sm sm:text-base font-medium">查詢狀態</button>
            <button data-tab="admin" class="tab-btn flex items-center text-sm sm:text-base font-medium">
                管理後台
                <span id="pending-count" class="ml-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden"></span>
            </button>
            <button data-tab="stats" class="tab-btn hidden text-sm sm:text-base font-medium">統計分析</button>
            <button data-tab="stats-dispatch" class="tab-btn hidden text-sm sm:text-base font-medium">領料明細</button>
        </nav>

        <main>
            <!-- Apply Tab -->
            <div id="tab-content-apply" class="tab-content bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <form id="dispatchForm" class="space-y-6">
                    <input type="hidden" id="request-id">
                    
                    <!-- Form Fields Grid - MODIFIED for multi-item -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-6 border-t border-b border-gray-200 py-6">
                        
                        <!-- Row 1 (Basic Info) -->
                        <div>
                            <label for="applicant_unit" class="block text-sm font-medium text-gray-700">申請單位</label>
                            <input type="text" id="applicant_unit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="cost_code" class="block text-sm font-medium text-gray-700">費用部門代號</label>
                            <input type="text" id="cost_code" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="applicant_name" class="block text-sm font-medium text-gray-700">申請人姓名</label>
                            <input type="text" id="applicant_name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="請輸入姓名">
                        </div>

                        <!-- Row 2 (Manager) -->
                        <div>
                            <label for="approving_manager_name" class="block text-sm font-medium text-gray-700">單位主管姓名</label>
                            <input type="text" id="approving_manager_name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="請輸入主管姓名">
                        </div>
                        <!-- Spacer -->
                        <div class="hidden lg:block lg:col-span-2"></div>
                    </div>

                    <!-- ***** NEW: Multi-Item Section ***** -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center border-t pt-6">
                                <h3 class="text-lg font-medium text-gray-800">申請品項</h3>
                                <button type="button" id="add-item-btn" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    ＋ 新增品項
                                </button>
                        </div>
                        
                        <div id="item-list-container" class="space-y-6">
                            <!-- Item rows will be injected here by JavaScript -->
                        </div>
                    </div>
                    <!-- ***** END: Multi-Item Section ***** -->


                    <!-- Row 4: Remarks (Now after item list) -->
                    <div class="lg:col-span-3 border-t pt-6">
                        <label for="remarks" class="block text-sm font-medium text-gray-700">總備註</label>
                        <textarea id="remarks" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="若有此筆申請單的特殊需求請在此說明..."></textarea>
                    </div>

                    <!-- Info Box -->
                    <div class="lg:col-span-3">
                        <p class="block text-sm font-medium text-red-600 mb-1">領料補充說明：</p>
                        <!-- UPDATED INFO BOX CONTENT -->
                        <div class="mt-1 block w-full px-3 py-2 bg-red-50 border-2 border-red-300 rounded-md shadow-sm text-sm text-red-800 font-semibold space-y-1">
                            <p>þ 申請酒精/藥品的結單時間：每周三中午12:00止</p>
                            <p>þ 領取申請酒精/藥品的地點時間：B1藥庫每周四下午13:00~16:00止</p>
                            <p>þ 如遇國定假日或春節連假，將另行公告提早領物資的日期。</p>
                        </div>
                    </div>


                    <!-- Admin Section (MODIFIED) -->
                    <div id="admin-section" class="hidden border-t border-gray-200 pt-6 mt-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">發料單位處理狀況</h2>
                        
                        <!-- ***** NEW: Admin Item List ***** -->
                        <div class="mb-6">
                            <h3 class="text-md font-medium text-gray-700 mb-2">品項處理</h3>
                            <div id="admin-item-list" class="space-y-3">
                                <!-- Admin item rows will be injected here by JavaScript -->
                            </div>
                        </div>
                        <!-- ***** END: Admin Item List ***** -->

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 border-t pt-6">
                            <div>
                                <label for="display_request_id" class="block text-sm font-medium text-gray-700">申請單號</label>
                                <input type="text" id="display_request_id" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                            <div>
                                <label for="process_status" class="block text-sm font-medium text-gray-700">處理狀況</label>
                                <select id="process_status" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                                    <option value="待單位主管簽核">待單位主管簽核</option>
                                    <option value="主管退回">主管退回</option>
                                    <option value="待發料單位處理">待發料單位處理</option>
                                    <option value="已備料">已備料</option>
                                    <option value="已發料">已發料</option>
                                    <option value="申請取消">申請取消</option>
                                    <option value="無法發料">無法發料</option>
                                </select>
                            </div>
                            <div>
                                <label for="approving_manager" class="block text-sm font-medium text-gray-700">簽核主管 (實際)</label>
                                <input type="text" id="approving_manager" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                            <div>
                                <label for="distribution_method" class="block text-sm font-medium text-gray-700">發料日期</label>
                                <input type="date" id="distribution_method" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                             <div>
                                <label for="issuer_assistant" class="block text-sm font-medium text-gray-700">發料藥佐</label>
                                <input type="text" id="issuer_assistant" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                             <div>
                                <label for="verifying_pharmacist" class="block text-sm font-medium text-gray-700">核對藥師</label>
                                <input type="text" id="verifying_pharmacist" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input">
                            </div>
                             <!-- "申請單位簽收人" 欄位已移除 -->
                            <div class="md:col-span-2">
                                <label for="management_remarks" class="block text-sm font-medium text-gray-700">發料單位備註 (總備註)</label>
                                <textarea id="management_remarks" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm disabled-input"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="pt-6 text-center flex items-center justify-center space-x-4">
                        <button type="submit" id="submit-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-12 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">提交新申請</button>
                        <button type="button" id="clear-btn" class="w-full sm:w-auto inline-flex justify-center py-3 px-8 border border-gray-300 shadow-sm text-base font-medium rounded-full text-gray-700 bg-white hover:bg-gray-50">清空表單</button>
                    </div>
                </form>
            </div>

            <!-- Search Tab -->
            <div id="tab-content-search" class="tab-content hidden bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-800 mb-6">查詢申請狀態</h2>
                <div class="flex items-center space-x-2 mb-6">
                    <input type="text" id="search-input" placeholder="請輸入申請人姓名、申請單號或費用部門代號進行查詢..." class="flex-grow block w-full px-4 py-2 bg-white border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <button id="search-btn" class="py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700">查詢</button>
                </div>
                <div id="search-results" class="space-y-4">
                    <p class="text-center text-gray-500">請輸入姓名、單號或費用部門代號以查詢您的申請記錄。</p>
                </div>
            </div>

            <!-- Admin Tab -->
            <div id="tab-content-admin" class="tab-content hidden bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <div id="admin-view">
                     <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4 gap-4">
                         <div class="flex items-center gap-2">
                             <h2 class="text-xl font-bold text-gray-800">所有領料申請</h2>
                             <button id="refresh-admin-list-btn" title="重新整理" class="p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                 <svg class="w-5 h-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.664 0l3.181-3.183m-4.991-2.691V5.25a8.25 8.25 0 00-11.664 0v4.992m11.664 0l-3.181-3.183" />
                                  </svg>
                             </button>
                         </div>
                         <div class="flex items-center space-x-2">
                             <input type="text" id="admin-search-input" placeholder="依申請單號查詢..." class="w-full sm:w-auto px-4 py-2 bg-white border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                         </div>
                         <button id="logout-btn" class="hidden py-2 px-4 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">登出</button>
                     </div>
                     <div id="requests-list" class="space-y-4">
                         <!-- Requests will be injected here by Firestore -->
                     </div>
                </div>
                 <div id="admin-login-prompt" class="text-center py-10">
                    <p class="text-gray-600">此為管理員專區，請先登入。</p>
                    <button id="admin-login-prompt-btn" class="mt-4 py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700">立即登入</button>
                </div>
            </div>

            <!-- Stats Tab -->
            <div id="tab-content-stats" class="tab-content hidden bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                 <div id="stats-view" class="hidden">
                     <div class="flex justify-between items-center mb-6 border-b pb-4">
                         <h2 class="text-xl font-bold text-gray-800">數據統計分析</h2>
                         <button id="export-excel-btn" class="py-2 px-4 bg-green-600 text-white rounded-md text-sm font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">匯出 Excel</button>
                     </div>

                     <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 p-4 bg-gray-50 rounded-lg">
                         <div class="flex items-center gap-2">
                             <label for="stats-month-filter" class="text-sm font-medium text-gray-700">篩選月份:</label>
                             <input type="month" id="stats-month-filter" class="border-gray-300 rounded-md shadow-sm p-2">
                         </div>
                         <div class="flex gap-4 text-center">
                             <div class="p-2">
                                 <p class="text-2xl font-bold text-blue-600" id="stats-total-requests">0</p>
                                 <p class="text-sm font-medium text-gray-500">總申請筆數</p>
                             </div>
                         </div>
                     </div>

                     <!-- Charts Updated -->
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                         <div class="p-4 border rounded-lg lg:col-span-2">
                             <h3 class="text-center font-semibold mb-4 text-gray-700">熱門申請品項 (Top 10)</h3>
                             <canvas id="item-chart"></canvas>
                         </div>
                         <div class="p-4 border rounded-lg lg:col-span-2">
                             <h3 class="text-center font-semibold mb-4 text-gray-700">各發料人員發料趟次統計</h3>
                             <canvas id="issuer-chart"></canvas>
                         </div>
                          <div class="p-4 border rounded-lg"><h3 class="text-center font-semibold mb-4 text-gray-700">申請狀態分佈</h3><canvas id="status-chart"></canvas></div>
                     </div>
                 </div>
                 <div id="stats-login-prompt" class="text-center py-10">
                     <p class="text-gray-600">此為管理員專區，請先登入查看統計數據。</p>
                     <button id="stats-login-prompt-btn" class="mt-4 py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700">立即登入</button>
                 </div>
            </div>
            
            <!-- ***** NEW: Stats Dispatch Tab Content ***** -->
            <div id="tab-content-stats-dispatch" class="tab-content hidden bg-white p-6 sm:p-8 rounded-b-2xl shadow-lg">
                <div id="stats-dispatch-view" class="hidden">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="text-xl font-bold text-gray-800">領料明細簽收</h2>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4 p-4 bg-gray-50 rounded-lg">
                         <div class="flex items-center gap-2">
                             <label for="stats-dispatch-date-filter" class="text-sm font-medium text-gray-700">選擇領料日期:</label>
                             <input type="date" id="stats-dispatch-date-filter" class="border-gray-300 rounded-md shadow-sm p-2">
                             <button id="stats-dispatch-generate-btn" class="py-2 px-4 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">產生領料單</button>
                         </div>
                         <div class="flex items-center space-x-2">
                             <input type="text" id="stats-dispatch-search-input" placeholder="依費用部門代號查詢..." class="w-full sm:w-auto px-4 py-2 bg-white border border-gray-300 rounded-full shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                         </div>
                    </div>
                    
                    <div id="stats-dispatch-results" class="mt-6 space-y-4">
                         <p class="text-center text-gray-500">請選擇日期以產生領料明細。</p>
                    </div>
                </div>
                <div id="stats-dispatch-login-prompt" class="text-center py-10">
                    <p class="text-gray-600">此為管理員專區，請先登入查看領料明細。</p>
                    <button id="stats-dispatch-login-prompt-btn" class="mt-4 py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700">立即登入</button>
                </div>
            </div>

        </main>
    </div>

    <!-- Custom Modal -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform transition-all">
            <h3 id="modal-title" class="text-lg font-medium text-gray-900">通知</h3>
            <div id="modal-content" class="mt-2 text-sm text-gray-600"></div>
            <div id="modal-buttons" class="mt-5 sm:mt-6 flex justify-end space-x-3"></div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, setLogLevel, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 藥品/材料資料庫 ---
        const itemDatabase = [
            { name: "75% 酒精 4000 mL", id: "03-002-42A025", unit: "桶" },
            { name: "75% 酒精 500 mL", id: "03-002-42A060", unit: "瓶" },
            { name: "C-B complex (2mL)針", id: "01-007-17V171", unit: "A" },
            { name: "Hyoscine Butylbromide(20mg/mL)", id: "01-003-13B042", unit: "A" },
            { name: "Lactated Ringer軟袋 (500mL)", id: "01-007-17L010", unit: "包" },
            { name: "Lidocaine(局麻)400mg/20mL針", id: "01-002-12X022", unit: "V" },
            { name: "NaCl(0.9%,20mL)針", id: "01-007-17N064", unit: "盒" },
            { name: "Parmason 0.2%漱口水(200mL)", id: "01-009-39C172", unit: "瓶" },
            { name: "Rocuronium-hameln (50mg/5mL/V)", id: "01-002-12R012", unit: "V" },
            { name: "Saline 沖洗用(500 mL)", id: "03-009-39N161", unit: "瓶" },
            { name: "Xylocaine 10% Spray 50mL", id: "01-002-32X054", unit: "瓶" },
            { name: "Xylocaine Jelly 2%30 gm", id: "31-002-32X012", unit: "條" },
            { name: "雙氧水 3% 450 mL", id: "01-009-39H024", unit: "瓶" },
            { name: "其他(自行輸入)", id: "", unit: "" }
        ];

        window.addEventListener('load', () => {
            const state = {
                isLoggedIn: false,
                requests: [],
                editingRequestId: null,
                activeTab: 'apply',
                db: null, // Firestore instance
                auth: null, // Auth instance
                deepLinkedRequestId: null,
                itemDatabase: itemDatabase, // Store database in state
                appId: null,
                collectionPath: null,
                itemRowCounter: 0
            };

            let statusChartInstance, itemChartInstance, issuerChartInstance;

            // --- CACHE ELEMENTS ---
            const form = document.getElementById('dispatchForm');
            const logoutBtn = document.getElementById('logout-btn');
            const submitBtn = document.getElementById('submit-btn');
            const clearBtn = document.getElementById('clear-btn');
            const requestIdInput = document.getElementById('request-id');
            const adminSection = document.getElementById('admin-section');
            // ***** NEW: Admin Item List Container *****
            const adminItemListContainer = document.getElementById('admin-item-list'); 
            
            // 移除 'applicant_signee'
            const adminFields = ['process_status', 'distribution_method', 'issuer_assistant', 'verifying_pharmacist', 'management_remarks'].map(id => document.getElementById(id));

            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            const adminView = document.getElementById('admin-view');
            const adminLoginPrompt = document.getElementById('admin-login-prompt');
            const adminLoginPromptBtn = document.getElementById('admin-login-prompt-btn');
            const requestsList = document.getElementById('requests-list');
            const pendingCountBadge = document.getElementById('pending-count');

            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const searchResults = document.getElementById('search-results');
            const adminSearchInput = document.getElementById('admin-search-input');
            const refreshAdminListBtn = document.getElementById('refresh-admin-list-btn');

            const statsTabBtn = document.querySelector('button[data-tab="stats"]');
            const statsView = document.getElementById('stats-view');
            const statsLoginPrompt = document.getElementById('stats-login-prompt');
            const statsLoginPromptBtn = document.getElementById('stats-login-prompt-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const statsMonthFilter = document.getElementById('stats-month-filter');
            const statsTotalRequests = document.getElementById('stats-total-requests');
            
            const addItemBtn = document.getElementById('add-item-btn');
            const itemListContainer = document.getElementById('item-list-container');

            const statsDispatchTabBtn = document.querySelector('button[data-tab="stats-dispatch"]');
            const statsDispatchView = document.getElementById('stats-dispatch-view');
            const statsDispatchLoginPrompt = document.getElementById('stats-dispatch-login-prompt');
            const statsDispatchLoginPromptBtn = document.getElementById('stats-dispatch-login-prompt-btn');
            const statsDispatchDateFilter = document.getElementById('stats-dispatch-date-filter');
            const statsDispatchGenerateBtn = document.getElementById('stats-dispatch-generate-btn');
            const statsDispatchResults = document.getElementById('stats-dispatch-results');
            const statsDispatchSearchInput = document.getElementById('stats-dispatch-search-input');


            // --- MODAL ELEMENTS & FUNCTIONS ---
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalButtons = document.getElementById('modal-buttons');

            function hideModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }
            function showAlert(message, title = '通知') {
                modalTitle.textContent = title;
                modalContent.innerHTML = `<p>${message}</p>`;
                modalButtons.innerHTML = `<button id="modal-ok-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">確定</button>`;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                const okBtn = document.getElementById('modal-ok-btn');
                okBtn.onclick = hideModal;
                okBtn.focus();
            }
            function showSuccessWithLink(message, link) {
                modalTitle.textContent = '申請成功';
                modalContent.innerHTML = `
                    <p>${message}</p>
                    <div class="mt-4">
                        <label for="approval-link" class="block text-sm font-medium text-gray-700 text-left">專屬簽核連結</label>
                        <input type="text" id="approval-link" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm" value="${link}">
                    </div>
                `;
                modalButtons.innerHTML = `
                    <button id="modal-copy-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">複製連結</button>
                    <button id="modal-close-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">關閉</button>
                `;
                modal.classList.remove('hidden');
                modal.classList.add('flex');

                const copyBtn = document.getElementById('modal-copy-btn');
                const closeBtn = document.getElementById('modal-close-btn');
                const linkInput = document.getElementById('approval-link');

                copyBtn.onclick = () => {
                    linkInput.select();
                    try {
                        // Use execCommand as a fallback for iframe environments
                        document.execCommand('copy');
                        copyBtn.textContent = '已複製！';
                    } catch (err) {
                        console.warn("Clipboard copy failed, likely due to iframe restrictions.");
                        copyBtn.textContent = '複製失敗';
                    }
                    setTimeout(() => { copyBtn.textContent = '複製連結'; }, 2000);
                };
                closeBtn.onclick = hideModal;
            }

            function showConfirm(message, callback, title = '確認操作') {
                modalTitle.textContent = title;
                modalContent.innerHTML = `<p>${message}</p>`;
                modalButtons.innerHTML = `
                    <button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">取消</button>
                    <button id="modal-confirm-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none">確定</button>
                `;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                const confirmBtn = document.getElementById('modal-confirm-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');
                confirmBtn.onclick = () => { hideModal(); if (callback) callback(true); };
                cancelBtn.onclick = () => { hideModal(); if (callback) callback(false); };
                confirmBtn.focus();
            }
            
            function promptLogin() {
                modalTitle.textContent = '管理員登入';
                modalContent.innerHTML = `<div class="space-y-4">
                    <div>
                        <label for="modal-username" class="block text-sm font-medium text-gray-700 text-left">帳號 (Admin Username)</label>
                        <input type="text" id="modal-username" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="modal-password" class="block text-sm font-medium text-gray-700 text-left">密碼 (Password)</label>
                        <input type="password" id="modal-password" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <p id="modal-error" class="text-sm text-red-600 h-4"></p>
                </div>`;
                modalButtons.innerHTML = `<button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">取消</button><button id="modal-login-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none">登入</button>`;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                const loginBtn = document.getElementById('modal-login-btn'), 
                      cancelBtn = document.getElementById('modal-cancel-btn'), 
                      usernameInput = document.getElementById('modal-username'), 
                      passwordInput = document.getElementById('modal-password'), 
                      errorEl = document.getElementById('modal-error');
                
                usernameInput.focus();
                
                const handleLogin = async () => {
                    const username = usernameInput.value.trim();
                    const password = passwordInput.value.trim();
                    errorEl.textContent = ''; 

                    // --- Hardcoded Obfuscated Check for admin:cch5500 ---
                    const P1 = 'cch';
                    const P2 = '550';
                    const P3 = '0';
                    const adminPassword = P1 + P2 + P3;
                    const adminUsername = 'admin';
                    // --- End Obfuscation ---

                    if (!username || !password) {
                        errorEl.textContent = '請輸入帳號和密碼。';
                        const modalBox = modal.querySelector('div'); modalBox.classList.add('animate-shake'); setTimeout(() => { modalBox.classList.remove('animate-shake'); }, 500);
                        return;
                    }

                    if (username === adminUsername && password === adminPassword) {
                        hideModal();
                        state.isLoggedIn = true;
                        showAlert('登入成功！', '管理員登入');
                        updateUI();
                        if (state.activeTab !== 'stats' && state.activeTab !== 'stats-dispatch') {
                            setActiveTab('admin');
                        }
                    } else {
                        errorEl.textContent = '帳號或密碼錯誤。';
                        const modalBox = modal.querySelector('div'); modalBox.classList.add('animate-shake'); setTimeout(() => { modalBox.classList.remove('animate-shake'); }, 500);
                    }
                };
                
                loginBtn.onclick = handleLogin;
                passwordInput.onkeydown = (e) => { if (e.key === 'Enter') handleLogin(); };
                usernameInput.onkeydown = (e) => { if (e.key === 'Enter') passwordInput.focus(); }; 
                cancelBtn.onclick = hideModal;
            }

            function promptManagerAction(callback) {
                modalTitle.textContent = '主管簽核';
                modalContent.innerHTML = `
                    <p class="mb-4">請輸入您的姓名並提供備註 (非必填)。</p>
                    <div class="space-y-4">
                        <div>
                            <label for="modal-manager-name" class="block text-sm font-medium text-gray-700 text-left">主管姓名</label>
                            <input type="text" id="modal-manager-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="modal-manager-remarks" class="block text-sm font-medium text-gray-700 text-left">備註</label>
                            <textarea id="modal-manager-remarks" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="若退回申請，請說明原因..."></textarea>
                        </div>
                        <p id="modal-error" class="text-sm text-red-600 h-4 mt-1"></p>
                    </div>`;
                modalButtons.innerHTML = `
                    <button id="modal-cancel-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none">取消</button>
                    <button id="modal-reject-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-yellow-600 text-base font-medium text-white hover:bg-yellow-700 focus:outline-none">退回申請</button>
                    <button id="modal-confirm-approve-btn" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none">確定簽核</button>`;

                modal.classList.remove('hidden');
                modal.classList.add('flex');

                const confirmBtn = document.getElementById('modal-confirm-approve-btn');
                const rejectBtn = document.getElementById('modal-reject-btn');
                const cancelBtn = document.getElementById('modal-cancel-btn');
                const managerNameInput = document.getElementById('modal-manager-name');
                const managerRemarksInput = document.getElementById('modal-manager-remarks');
                const errorEl = document.getElementById('modal-error');
                managerNameInput.focus();

                const handleAction = (isApproved) => {
                    const name = managerNameInput.value.trim();
                    const remarks = managerRemarksInput.value.trim();
                    if (!name) {
                        errorEl.textContent = '主管姓名為必填欄位。';
                        const modalBox = modal.querySelector('div > div');
                        if(modalBox) {
                           modalBox.classList.add('animate-shake');
                           setTimeout(() => { modalBox.classList.remove('animate-shake'); }, 500);
                        }
                        return;
                    }
                    hideModal();
                    if (callback) callback({ approved: isApproved, name, remarks });
                };

                confirmBtn.onclick = () => handleAction(true);
                rejectBtn.onclick = () => handleAction(false);
                cancelBtn.onclick = () => { hideModal(); if (callback) callback(null); };
            }

            // --- TAB HANDLING ---
            function setActiveTab(tabName) {
                state.activeTab = tabName;
                tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tabName));
                tabContents.forEach(content => content.classList.toggle('hidden', content.id !== `tab-content-${tabName}`));
                
                if (tabName === 'admin') updateAdminTabVisibility();
                
                if (tabName === 'stats') {
                     if (!statsMonthFilter.value) {
                         const now = new Date();
                         const year = now.getFullYear();
                         const month = (now.getMonth() + 1).toString().padStart(2, '0');
                         statsMonthFilter.value = `${year}-${month}`;
                     }
                    updateStatsTabVisibility();
                    renderStatistics();
                 }
                 
                 if (tabName === 'stats-dispatch') {
                     if (!statsDispatchDateFilter.value) {
                         const now = new Date();
                         const year = now.getFullYear();
                         const month = (now.getMonth() + 1).toString().padStart(2, '0');
                         const day = now.getDate().toString().padStart(2, '0');
                         statsDispatchDateFilter.value = `${year}-${month}-${day}`;
                     }
                    updateStatsDispatchTabVisibility();
                    if (statsDispatchDateFilter.value) {
                         renderDispatchList();
                    } else {
                         statsDispatchResults.innerHTML = '<p class="text-center text-gray-500">請選擇日期以產生領料明細。</p>';
                    }
                 }
            }

            // --- AUTHENTICATION & UI ---
            function logout() { 
                if (state.auth && state.auth.currentUser && !state.auth.currentUser.isAnonymous) {
                    signOut(state.auth).catch(e => console.error("Error signing out:", e));
                }
                state.isLoggedIn = false; 
                showAlert('已登出。'); 
                updateUI(); 
                resetForm(); 
                setActiveTab('apply'); 
            }

            function updateAdminTabVisibility() {
                const showAdminView = state.isLoggedIn && state.activeTab === 'admin';
                adminView.classList.toggle('hidden', !showAdminView);
                adminLoginPrompt.classList.toggle('hidden', showAdminView);
            }
            function updateStatsTabVisibility() {
                const showStatsView = state.isLoggedIn && state.activeTab === 'stats';
                statsView.classList.toggle('hidden', !showStatsView);
                statsLoginPrompt.classList.toggle('hidden', showStatsView);
            }
            
            function updateStatsDispatchTabVisibility() {
                const showStatsDispatchView = state.isLoggedIn && state.activeTab === 'stats-dispatch';
                statsDispatchView.classList.toggle('hidden', !showStatsDispatchView);
                statsDispatchLoginPrompt.classList.toggle('hidden', showStatsDispatchView);
            }

            function updateUI() {
                if (state.isLoggedIn) {
                    statsTabBtn.classList.remove('hidden');
                    statsDispatchTabBtn.classList.remove('hidden');
                    if (logoutBtn) logoutBtn.classList.remove('hidden');

                    const pendingCount = state.requests.filter(r => r.dispatchStatus === '待發料單位處理').length;
                    if(pendingCount > 0) {
                        pendingCountBadge.textContent = pendingCount;
                        pendingCountBadge.classList.remove('hidden');
                        pendingCountBadge.classList.add('animate-pulse-badge');
                    } else {
                        pendingCountBadge.classList.add('hidden');
                        pendingCountBadge.classList.remove('animate-pulse-badge');
                    }
                } else {
                    statsTabBtn.classList.add('hidden');
                    statsDispatchTabBtn.classList.add('hidden');
                    if (logoutBtn) logoutBtn.classList.add('hidden');
                    pendingCountBadge.classList.add('hidden');
                }
                updateAdminTabVisibility();
                updateStatsTabVisibility();
                updateStatsDispatchTabVisibility();
                renderAdminList();
            }

            function getStatusBadgeClass(status) {
                 switch(status) {
                     case '待單位主管簽核': return 'status-manager-approval';
                     case '主管退回': return 'status-manager-rejected';
                     case '待發料單位處理': return 'status-pending';
                     case '已備料': return 'status-dispatched';
                     case '已發料': return 'status-dispatched';
                     case '申請取消': return 'status-cancelled';
                     case '無法發料': return 'status-rejected';
                     default: return 'status-rejected';
                 }
            }

            // --- DATA FILTERING ---
            function getFilteredRequests() {
                const filterValue = statsMonthFilter.value; // YYYY-MM
                if (!filterValue) {
                    return state.requests;
                }
                const [year, month] = filterValue.split('-').map(Number);
                return state.requests.filter(req => {
                    if (!req.createdAt || !req.createdAt.toDate) return false;
                    const reqDate = req.createdAt.toDate();
                    return reqDate.getFullYear() === year && (reqDate.getMonth() + 1) === month;
                });
            }

            // --- RENDER FUNCTIONS ---
            async function handleManagerAction(id) {
                if (!id || !state.db || !state.collectionPath) return;
                promptManagerAction(async (action) => {
                    if (action) {
                         const docRef = doc(state.db, state.collectionPath, id);
                        try {
                            if (action.approved) {
                                await updateDoc(docRef, {
                                    dispatchStatus: '待發料單位處理', 
                                    approvingManager: action.name,
                                    managerRemarks: action.remarks
                                  });
                                showAlert('申請單已簽核！');
                            } else {
                                 await updateDoc(docRef, {
                                    dispatchStatus: '主管退回',
                                    approvingManager: action.name,
                                    managerRemarks: action.remarks
                                  });
                                showAlert('申請單已退回。');
                            }
                        } catch (error) {
                            console.error("Error during manager action:", error);
                            showAlert('操作失敗，請稍後再試。', '錯誤');
                        }
                    }
                });
            }

            function renderAdminList() {
                const query = adminSearchInput.value.trim().toLowerCase();
                const requestsToRender = query
                    ? state.requests.filter(req => req.requestId?.toLowerCase().includes(query))
                    : state.requests;

                requestsList.innerHTML = '';
                if(requestsToRender.length === 0) {
                     requestsList.innerHTML = `<p class="text-center text-gray-500">${query ? '找不到符合條件的申請。' : '目前沒有任何申請記錄。'}</p>`;
                     return;
                }

                requestsToRender.forEach(req => {
                    const card = document.createElement('div');
                    card.className = 'request-card p-4 border rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3';
                    const createdAt = req.createdAt?.toDate() ? req.createdAt.toDate().toLocaleString('zh-TW', { hour12: false }).slice(0, 16) : 'N/A';

                    let buttonsHTML = '';
                    if (req.dispatchStatus === '待單位主管簽核') {
                        buttonsHTML += `<button class="text-sm text-green-600 hover:text-green-800 font-medium approve-btn">主管簽核</button>`;
                    }
                    buttonsHTML += `<button class="text-sm text-blue-600 hover:text-blue-800 font-medium edit-btn">檢視/編輯</button>`;
                    buttonsHTML += `<button class="text-sm text-red-600 hover:text-red-800 font-medium delete-btn">刪除</button>`;

                    let itemSummary = '無品項資訊';
                    if (req.items && req.items.length > 0) {
                        itemSummary = `${req.items[0].itemName} (數量: ${req.items[0].quantity})`;
                        if (req.items.length > 1) {
                            itemSummary += ` ...等 ${req.items.length} 項`;
                        }
                    }

                    card.innerHTML = `<div class="flex-grow">
                        <p class="font-semibold text-gray-800">${req.applicantUnit || 'N/A'} - ${req.applicantName || 'N/A'}</p>
                        <p class="text-xs text-gray-400">單號: ${req.requestId || 'N/A'}</p>
                        <p class="text-sm text-gray-500">申請時間: ${createdAt}</p>
                        <p class="text-sm text-gray-700 font-medium">品項: ${itemSummary}</p>
                    </div><div class="flex items-center flex-shrink-0 gap-4">${buttonsHTML} <span class="status-badge ${getStatusBadgeClass(req.dispatchStatus)}">${req.dispatchStatus}</span></div>`;

                    const approveBtn = card.querySelector('.approve-btn');
                    if (approveBtn) {
                        approveBtn.addEventListener('click', (e) => { e.stopPropagation(); handleManagerAction(req.id); });
                    }

                    card.querySelector('.edit-btn').addEventListener('click', () => { loadRequestIntoForm(req.id); setActiveTab('apply'); });
                    card.querySelector('.delete-btn').addEventListener('click', (e) => {
                         e.stopPropagation();
                         showConfirm(`確定要刪除由 ${req.applicantName} 提出的申請嗎？`, confirmed => {
                             if (confirmed) deleteRequest(req.id);
                        });
                     });
                    requestsList.appendChild(card);
                });
            }

            function handleSearch() {
                const query = searchInput.value.trim();
                if (!query) { searchResults.innerHTML = `<p class="text-center text-gray-500">請輸入姓名、單號或費用部門代號以查詢您的申請記錄。</p>`; return; }
                
                const results = state.requests.filter(req =>
                    (req.applicantName && req.applicantName.includes(query)) ||
                    (req.requestId && req.requestId.includes(query)) ||
                    (req.costCode && req.costCode.includes(query))
                );
                
                searchResults.innerHTML = '';
                if (results.length === 0) { searchResults.innerHTML = `<p class="text-center text-gray-500">找不到符合「${query}」的申請記錄。</p>`; return; }

                results.forEach(req => {
                    const card = document.createElement('div');
                    card.className = 'p-4 border rounded-lg bg-gray-50 space-y-2';
                    const createdAt = req.createdAt?.toDate() ? req.createdAt.toDate().toLocaleString('zh-TW', { hour12: false }).slice(0, 16) : 'N/A';
                    const dispatchDate = req.dispatchMethod ? req.dispatchMethod : '---';
                    const signeeTimestamp = req.signeeTimestamp?.toDate() ? req.signeeTimestamp.toDate().toLocaleString('zh-TW', { hour12: false }).slice(0, 16) : '---';

                    let managerActionsHTML = '';
                    if (req.dispatchStatus === '待單位主管簽核') {
                        managerActionsHTML = `<div class="mt-2 pt-2 border-t"><button class="w-full text-center py-2 px-4 bg-green-100 text-green-800 rounded-md hover:bg-green-200 approve-btn-search">主管簽核</button></div>`;
                    }

                    // ***** MODIFIED: Create items list HTML with new fields *****
                    let itemsHtml = '<p class="sm:col-span-2"><strong>申請品項:</strong></p><ul class="sm:col-span-2 list-disc pl-8 space-y-1 text-sm">';
                    if (req.items && req.items.length > 0) {
                        req.items.forEach(item => {
                            itemsHtml += `<li>${item.itemName || 'N/A'} (編號: ${item.materialId || 'N/A'}) - 申請數量: ${item.quantity || 'N/A'} ${item.itemUnit || ''}`;
                            
                            // Add applicant item remarks
                            if (item.itemRemarks) {
                                itemsHtml += `<br><span class="text-xs text-gray-500 italic">└ 申請備註: ${item.itemRemarks}</span>`;
                            }

                            // Add admin dispatch info
                            if (item.dispatchQuantity || item.dispatchRemarks) {
                                itemsHtml += `<ul class="list-square pl-6 text-xs text-blue-700">`;
                                if (item.dispatchQuantity) {
                                    itemsHtml += `<li>發料數量: ${item.dispatchQuantity}</li>`;
                                }
                                if (item.dispatchRemarks) {
                                    itemsHtml += `<li>發料備註: ${item.dispatchRemarks}</li>`;
                                }
                                itemsHtml += `</ul>`;
                            }
                            itemsHtml += `</li>`;
                        });
                    } else {
                        itemsHtml += '<li>無品項資訊</li>';
                    }
                    itemsHtml += '</ul>';


                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <p class="font-semibold text-gray-800">${req.applicantUnit} - ${req.applicantName}</p>
                            <span class="status-badge ${getStatusBadgeClass(req.dispatchStatus)}">${req.dispatchStatus}</span>
                        </div>
                        <p class="text-xs text-gray-500">申請單號: ${req.requestId || 'N/A'}</p>
                        <div class="text-sm text-gray-600 grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1">
                            <p><strong>申請時間:</strong> ${createdAt}</p>
                            <p><strong>申請人:</strong> ${req.applicantName || '---'}</p>
                            
                            <p><strong>費用部門:</strong> ${req.costCode || '---'}</p>
                            <p><strong>送簽主管:</strong> ${req.submittedApprover || '---'}</p>
                            
                            ${req.approvingManager ? `<p><strong>實際簽核主管:</strong> ${req.approvingManager}</p>` : ''}
                            ${req.managerRemarks ? `<p class="sm:col-span-2"><strong>主管備註:</strong> ${req.managerRemarks}</p>` : ''}
                            
                            <p><strong>發料日期:</strong> ${dispatchDate}</p>
                            <p><strong>發料藥佐:</strong> ${req.driverName || '---'}</p>
                            <p><strong>核對藥師:</strong> ${req.driverPhone || '---'}</p>
                            <p><strong>申請單位簽收人:</strong> ${req.applicantSignee || '---'}</p>
                            <p><strong>簽收時間:</strong> ${signeeTimestamp}</p>
                            
                            <p class="sm:col-span-2"><strong>總備註:</strong> ${req.remarks || '---'}</p>
                            ${req.adminRemarks ? `<p class="sm:col-span-2"><strong>發料單位備註 (總):</strong> ${req.adminRemarks}</p>` : ''}

                            ${itemsHtml}
                        </div>
                        ${managerActionsHTML}`;
                    searchResults.appendChild(card);

                    const approveBtnSearch = card.querySelector('.approve-btn-search');
                    if (approveBtnSearch) {
                        approveBtnSearch.addEventListener('click', () => handleManagerAction(req.id));
                    }
                });
            }

            function renderStatistics() {
                if (!state.isLoggedIn) return;

                const filteredRequests = getFilteredRequests();
                statsTotalRequests.textContent = filteredRequests.length;

                // --- Issuer Chart ---
                const issuerCtx = document.getElementById('issuer-chart').getContext('2d');
                const issuerTrips = filteredRequests
                    .filter(r => (r.dispatchStatus === '已發料' || r.dispatchStatus === '已備料') && r.driverName)
                    .reduce((acc, req) => { acc[req.driverName] = (acc[req.driverName] || 0) + 1; return acc; }, {});
                const sortedIssuers = Object.entries(issuerTrips).sort((a, b) => b[1] - a[1]);
                if (issuerChartInstance) issuerChartInstance.destroy();
                issuerChartInstance = new Chart(issuerCtx, {
                    type: 'bar', data: { labels: sortedIssuers.map(d => d[0]), datasets: [{ label: '發料次數', data: sortedIssuers.map(d => d[1]), backgroundColor: 'rgba(22, 163, 74, 0.5)', borderColor: 'rgba(22, 163, 74, 1)', borderWidth: 1 }] },
                    options: { indexAxis: 'y', scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } }, responsive: true }
                });

                // --- Status Chart ---
                const statusCtx = document.getElementById('status-chart').getContext('2d');
                const statusCounts = filteredRequests.reduce((acc, req) => { acc[req.dispatchStatus] = (acc[req.dispatchStatus] || 0) + 1; return acc; }, {});
                if(statusChartInstance) statusChartInstance.destroy();
                statusChartInstance = new Chart(statusCtx, {
                    type: 'pie', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#e0e7ff', '#fef3c7', '#d1fae5', '#fee2e2', '#e5e7eb', '#FEF9C3'], borderColor: ['#3730a3', '#92400e', '#065f46', '#991b1b', '#4b5563', '#713F12'], borderWidth: 1 }] },
                    options: { responsive: true, maintainAspectRatio: true }
                });

                // --- Item Chart (MODIFIED) ---
                const itemCtx = document.getElementById('item-chart').getContext('2d');
                const itemCounts = filteredRequests.reduce((acc, req) => { 
                    if (req.items && Array.isArray(req.items)) {
                        req.items.forEach(item => {
                            if (item.itemName) {
                                const name = item.itemName.split(' (')[0]; // Simplify name
                                acc[name] = (acc[name] || 0) + 1; // Count instances
                            }
                        });
                    }
                    return acc; 
                }, {});
                const sortedItems = Object.entries(itemCounts).sort((a, b) => b[1] - a[1]).slice(0, 10); // Top 10
                if(itemChartInstance) itemChartInstance.destroy();
                itemChartInstance = new Chart(itemCtx, {
                    type: 'bar', 
                    data: { 
                        labels: sortedItems.map(d => d[0]), 
                        datasets: [{ 
                            label: '申請次數', 
                            data: sortedItems.map(d => d[1]), 
                            backgroundColor: 'rgba(59, 130, 246, 0.5)', 
                            borderColor: 'rgba(59, 130, 246, 1)', 
                            borderWidth: 1 
                        }] 
                    },
                    options: { 
                        indexAxis: 'y',
                        scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
            
            // --- ***** MODIFIED: Render Dispatch List Function ***** ---
            async function handleSaveSignature(event) {
                const button = event.currentTarget;
                const unit = button.dataset.unit;
                const card = button.closest('.unit-dispatch-card');
                const signeeName = card.querySelector('.signee-input').value.trim();
                const requestIds = JSON.parse(button.dataset.requestIds);
                
                if (!signeeName) {
                    showAlert('請輸入簽收人姓名。', '錯誤');
                    card.querySelector('.signee-input').focus();
                    return;
                }
                
                button.disabled = true;
                button.textContent = '儲存中...';

                try {
                    const timestamp = serverTimestamp();
                    const batch = writeBatch(state.db);
                    
                    requestIds.forEach(id => {
                        const docRef = doc(state.db, state.collectionPath, id);
                        batch.update(docRef, { 
                            applicantSignee: signeeName, 
                            signeeTimestamp: timestamp 
                        });
                    });
                    
                    await batch.commit();
                    showAlert(`單位 [${unit}] 的簽收已儲存。\n簽收人: ${signeeName}`);
                    
                } catch (error) {
                    console.error("Error saving signature:", error);
                    showAlert('儲存簽收失敗，請稍後再試。', '錯誤');
                     if (button) {
                         button.disabled = false;
                         button.textContent = '儲存簽收';
                     }
                } 
            }

            function renderDispatchList() {
                const selectedDate = statsDispatchDateFilter.value;
                const searchQuery = statsDispatchSearchInput.value.trim().toLowerCase();

                if (!selectedDate) {
                     if (!searchQuery) { 
                         statsDispatchResults.innerHTML = '<p class="text-center text-gray-500">請先選擇日期並點擊「產生領料單」。</p>';
                    } else {
                        statsDispatchResults.innerHTML = '<p class="text-center text-gray-500">請先選擇日期並點擊「產生領料單」。</p>';
                    }
                    return;
                }
                
                let requestsForDate = state.requests.filter(r => r.dispatchMethod === selectedDate);
                
                if (searchQuery) {
                    requestsForDate = requestsForDate.filter(r => r.costCode?.toLowerCase().includes(searchQuery));
                }

                if (requestsForDate.length === 0) {
                     if (searchQuery) {
                         statsDispatchResults.innerHTML = `<p class="text-center text-gray-500">日期 [${selectedDate}] 查無符合費用部門代號 [${searchQuery}] 的領料資料。</p>`;
                    } else {
                        statsDispatchResults.innerHTML = `<p class="text-center text-gray-500">日期 [${selectedDate}] 查無領料資料。</p>`;
                    }
                    return;
                }

                // Group by unit
                const units = new Map();
                requestsForDate.forEach(req => {
                    const unit = req.applicantUnit || '未分類單位';
                    
                    if (!units.has(unit)) {
                        units.set(unit, { 
                            items: [], 
                            requestIds: [], 
                            signee: '', 
                            timestamp: null,
                            costCode: req.costCode
                        });
                    }
                    const unitData = units.get(unit);
                    unitData.requestIds.push(req.id);
                    if (req.items && Array.isArray(req.items)) {
                        req.items.forEach(item => {
                            // Add applicantName and remarks to item for reference
                            unitData.items.push({ 
                                ...item, 
                                applicantName: req.applicantName
                                // itemRemarks and dispatchRemarks are already in ...item
                            });
                        });
                    }
                    
                    if (req.signeeTimestamp && (!unitData.timestamp || req.signeeTimestamp.seconds > unitData.timestamp.seconds)) {
                        unitData.signee = req.applicantSignee;
                        unitData.timestamp = req.signeeTimestamp;
                    } else if (req.applicantSignee && !unitData.signee) {
                        unitData.signee = req.applicantSignee;
                    }
                });
                
                statsDispatchResults.innerHTML = ''; 
                
                if (units.size === 0 && searchQuery) {
                     statsDispatchResults.innerHTML = `<p class="text-center text-gray-500">日期 [${selectedDate}] 查無符合費用部門代號 [${searchQuery}] 的領料資料。</p>`;
                     return;
                 }

                // Aggregate items within each unit
                units.forEach((unitData, unit) => {
                    const aggregatedItems = new Map();
                    unitData.items.forEach(item => {
                        const key = `${item.itemName}|${item.materialId}|${item.itemUnit}`;
                        if (!aggregatedItems.has(key)) {
                            aggregatedItems.set(key, { 
                                itemName: item.itemName, 
                                materialId: item.materialId, 
                                itemUnit: item.itemUnit, 
                                totalQuantity: 0,
                                applicants: new Set(),
                                // ***** MODIFIED: Store remarks *****
                                applicantRemarks: [],
                                dispatchRemarks: []
                            });
                        }
                        const entry = aggregatedItems.get(key);
                        // ***** MODIFIED: Use dispatchQuantity if available, fallback to quantity *****
                        const quantity = parseInt(item.dispatchQuantity || item.quantity, 10);
                        if (!isNaN(quantity)) {
                            entry.totalQuantity += quantity;
                        }
                        entry.applicants.add(item.applicantName);
                        // ***** MODIFIED: Aggregate remarks *****
                        if (item.itemRemarks) {
                            entry.applicantRemarks.push(`(${item.applicantName}) ${item.itemRemarks}`);
                        }
                        if (item.dispatchRemarks) {
                             entry.dispatchRemarks.push(`(${item.applicantName}的品項) ${item.dispatchRemarks}`);
                        }
                    });
                    
                    // --- Create Card ---
                    const card = document.createElement('div');
                    card.className = 'unit-dispatch-card p-4 border rounded-lg bg-white shadow';
                    
                    let itemsHtml = '<ul class="list-disc pl-6 my-2 space-y-2">'; // Added space-y-2
                    if (aggregatedItems.size === 0) {
                        itemsHtml += '<li>無品項資料</li>';
                    } else {
                        aggregatedItems.forEach(item => {
                            // ***** MODIFIED: Display aggregated remarks *****
                            let remarksHtml = '';
                            if (item.applicantRemarks.length > 0) {
                                remarksHtml += `<div class="text-xs text-gray-500 mt-1 pl-2 border-l-2 border-gray-300 italic"><strong>申請備註:</strong><br>${item.applicantRemarks.join('<br>')}</div>`;
                            }
                             if (item.dispatchRemarks.length > 0) {
                                remarksHtml += `<div class="text-xs text-blue-600 mt-1 pl-2 border-l-2 border-blue-300"><strong>發料備註:</strong><br>${item.dispatchRemarks.join('<br>')}</div>`;
                            }

                            itemsHtml += `
                                <li class="text-sm">
                                    <strong class="text-base">${item.itemName || 'N/A'}</strong> (編號: ${item.materialId || 'N/A'})<br>
                                    總數量: <span class="font-bold text-blue-600">${item.totalQuantity}</span> ${item.itemUnit || ''}
                                    <span class="text-xs text-gray-500 block">(申請人: ${Array.from(item.applicants).join(', ')})</span>
                                    ${remarksHtml}
                                </li>`;
                        });
                    }
                    itemsHtml += '</ul>';
                    
                    const timestampStr = unitData.timestamp ? `(於 ${unitData.timestamp.toDate().toLocaleString('zh-TW', { hour12: false }).slice(0, 16)} 簽收)` : '';
                    
                    const unitTitle = unitData.costCode ? `${unit} (${unitData.costCode})` : unit;

                    card.innerHTML = `
                        <h3 class="text-lg font-bold text-gray-800 border-b pb-2">單位: ${unitTitle}</h3>
                        ${itemsHtml}
                        <div class="mt-4 pt-4 border-t flex flex-col sm:flex-row gap-4 items-center">
                            <label for="signee-${unit}" class="text-sm font-medium text-gray-700 flex-shrink-0">簽收人:</label>
                            <input type="text" id="signee-${unit}" class="signee-input w-full sm:w-auto flex-grow px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" data-unit="${unit}" value="${unitData.signee || ''}">
                            <button class="save-signee-btn w-full sm:w-auto py-2 px-4 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700" data-unit="${unit}" data-request-ids='${JSON.stringify(unitData.requestIds)}'>儲存簽收</button>
                        </div>
                        <p class="text-xs text-gray-500 text-right h-4 mt-1 signee-timestamp">${timestampStr}</p>
                    `;
                    
                    statsDispatchResults.appendChild(card);
                    
                    card.querySelector('.save-signee-btn').addEventListener('click', handleSaveSignature);
                });
            }


            // --- EXCEL EXPORT (MODIFIED) ---
            function exportToExcel() {
                const filteredRequests = getFilteredRequests();
                
                // ***** MODIFIED: Flatten data for Excel (one row per item) & set column order *****
                const dataToExport = [];
                
                filteredRequests.forEach(req => {
                    const items = (req.items && req.items.length > 0) ? req.items : [{}];
                    
                    items.forEach(item => {
                        const rowData = {
                            '申請單號': req.requestId,
                            '申請時間': req.createdAt?.toDate()?.toLocaleString('zh-TW', { hour12: false }) || '',
                            '申請狀態': req.dispatchStatus,
                            '申請單位': req.applicantUnit,
                            '費用部門代號': req.costCode,
                            '申請人': req.applicantName,
                            '送簽主管': req.submittedApprover,
                            '實際簽核主管': req.approvingManager,
                            '主管備註': req.managerRemarks,
                            '發料日期': req.dispatchMethod,
                            '發料藥佐': req.driverName,
                            '核對藥師': req.driverPhone,
                            // --- NEW/MODIFIED ITEM FIELDS ---
                            '領料品項名稱': item.itemName || 'N/A',
                            '材料編號': item.materialId || 'N/A',
                            '單位': item.itemUnit || 'N/A',
                            '申請數量': item.quantity || 'N/A',
                            '品項申請備註': item.itemRemarks || '', // ***** NEW *****
                            '發料數量': item.dispatchQuantity || '', // ***** NEW *****
                            '品項發料備註': item.dispatchRemarks || '', // ***** NEW *****
                            // --- END ITEM FIELDS ---
                            '總備註': req.remarks,
                            '發料單位總備註': req.adminRemarks,
                            '申請單位簽收人': req.applicantSignee || '',
                            '簽收時間': req.signeeTimestamp?.toDate()?.toLocaleString('zh-TW', { hour12: false }) || ''
                        };
                        dataToExport.push(rowData);
                    });
                });

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, '藥品材料申請單');
                XLSX.writeFile(workbook, `藥品材料申請單_${statsMonthFilter.value || '全部'}.xlsx`);
            }

            // --- FORM LOGIC ---
            function resetForm() {
                form.reset();
                adminSection.classList.add('hidden');
                // ***** NEW: Clear admin item list *****
                adminItemListContainer.innerHTML = ''; 
                
                document.getElementById('approving_manager').value = '';
                document.getElementById('management_remarks').value = '';
                state.editingRequestId = null;
                requestIdInput.value = '';
                submitBtn.textContent = '提交新申請';
                submitBtn.disabled = false;
                submitBtn.classList.replace('bg-green-600', 'bg-blue-600');
                submitBtn.classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
                clearBtn.classList.remove('hidden');
                addItemBtn.classList.remove('hidden');

                const allUserFields = form.querySelectorAll('input, textarea, select');
                allUserFields.forEach(el => {
                    if (!el.closest('#admin-section')) {
                        el.disabled = false;
                        el.classList.remove('disabled-input');
                    }
                });

                itemListContainer.innerHTML = '';
                state.itemRowCounter = 0;
                createItemRow(); // Add one empty row back

                adminSection.classList.add('hidden');
                adminFields.forEach(el => { el.disabled = true; el.classList.add('disabled-input'); });
            }

            function loadRequestIntoForm(id) {
                const request = state.requests.find(r => r.id === id); if (!request) return;

                resetForm();
                adminSection.classList.remove('hidden');
                state.editingRequestId = id;
                requestIdInput.value = id;
                document.getElementById('display_request_id').value = request.requestId || '';

                const fieldMapping = {
                    applicant_unit: request.applicantUnit,
                    cost_code: request.costCode,
                    applicant_name: request.applicantName,
                    approving_manager_name: request.submittedApprover, 
                    remarks: request.remarks,
                    
                    process_status: request.dispatchStatus,
                    distribution_method: request.dispatchMethod,
                    issuer_assistant: request.driverName, 
                    verifying_pharmacist: request.driverPhone, 
                    /* 'applicant_signee' 已移除 */
                    management_remarks: request.adminRemarks 
                };

                for (const [key, value] of Object.entries(fieldMapping)) {
                    const el = document.getElementById(key);
                    if (el) el.value = value || '';
                }
                document.getElementById('approving_manager').value = request.approvingManager || ''; 

                const userFields = [
                    'applicant_unit', 'cost_code', 'applicant_name', 'approving_manager_name', 'remarks'
                ].map(id => document.getElementById(id));
                
                userFields.forEach(el => { 
                    if (el) {
                        el.disabled = true; 
                        el.classList.add('disabled-input');
                    }
                });

                // ***** MODIFIED: Load APPLICANT items (disabled) *****
                itemListContainer.innerHTML = ''; // Clear the default row
                if (request.items && Array.isArray(request.items)) {
                    request.items.forEach(item => {
                        createItemRow(item, true); // Pass item data and 'disabled' flag
                    });
                }
                addItemBtn.classList.add('hidden'); // Hide "Add Item" button when viewing

                // ***** NEW: Load ADMIN item list (with inputs) *****
                adminItemListContainer.innerHTML = ''; // Clear admin item list
                if (request.items && Array.isArray(request.items)) {
                    request.items.forEach((item, index) => {
                        const adminItemRow = document.createElement('div');
                        adminItemRow.className = 'item-row-admin';
                        // Store index and original qty for validation
                        adminItemRow.dataset.itemIndex = index; 
                        
                        // Use dispatchQuantity if it exists, otherwise default to item.quantity
                        const dispatchQty = (item.dispatchQuantity !== undefined && item.dispatchQuantity !== null) ? item.dispatchQuantity : (item.quantity || '0');

                        adminItemRow.innerHTML = `
                            <p class="font-semibold text-gray-800">${item.itemName || 'N/A'}</p>
                            <p class="text-xs text-gray-500">編號: ${item.materialId || 'N/A'} | 單位: ${item.itemUnit || 'N/A'}</p>
                            <p class="text-sm text-gray-600">申請數量: <span class="font-bold text-blue-600">${item.quantity || '0'}</span></p>
                            ${item.itemRemarks ? `<p class="text-xs text-gray-500 italic mt-1">└ 申請備註: ${item.itemRemarks}</p>` : ''}
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-2 mt-2 pt-2 border-t border-gray-200">
                                <div class="md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700">發料数量</label>
                                    <input type="text" class="admin-dispatch-qty mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value="${dispatchQty}" data-original-qty="${item.quantity || '0'}">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700">發料備註 (必填 if 數量 != 申請)</label>
                                    <input type="text" class="admin-dispatch-remarks mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" value="${item.dispatchRemarks || ''}">
                                </div>
                            </div>
                        `;
                        adminItemListContainer.appendChild(adminItemRow);
                    });
                }

                const isAdmin = state.isLoggedIn;
                const canAdminEdit = isAdmin && ['待發料單位處理', '已備料', '已發料', '申請取消', '無法發料', '主管退回'].includes(request.dispatchStatus);

                // Enable/disable global admin fields
                adminFields.forEach(el => {
                    el.disabled = !canAdminEdit;
                    el.classList.toggle('disabled-input', !canAdminEdit);
                });
                document.getElementById('process_status').disabled = !canAdminEdit;

                // ***** NEW: Enable/disable admin item list inputs *****
                adminItemListContainer.querySelectorAll('input').forEach(input => {
                    input.disabled = !canAdminEdit;
                    input.classList.toggle('disabled-input', !canAdminEdit);
                });


                if (canAdminEdit) {
                    submitBtn.textContent = '更新處理進度';
                    submitBtn.disabled = false;
                    submitBtn.classList.replace('bg-blue-600', 'bg-green-600');
                    submitBtn.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
                } else {
                    submitBtn.textContent = '檢視中 (唯讀)';
                    submitBtn.disabled = true;
                }
                clearBtn.classList.add('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            async function deleteRequest(id) {
                if (!id || !state.db || !state.collectionPath) return;
                const docRef = doc(state.db, state.collectionPath, id);
                try {
                    await deleteDoc(docRef);
                    showAlert('申請單已成功刪除。');
                    resetForm();
                } catch (error) {
                    console.error("Error deleting document:", error);
                    showAlert('刪除失敗，請稍後再試。', '錯誤');
                }
            }

            // --- FIRESTORE & INITIALIZATION ---
            function listenForRequests() {
                if (!state.db || !state.collectionPath) return;
                const requestsColRef = collection(state.db, state.collectionPath);
                onSnapshot(requestsColRef, (snapshot) => {
                    state.requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    state.requests.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                    if (state.deepLinkedRequestId && state.requests.length > 0) {
                        const request = state.requests.find(r => r.id === state.deepLinkedRequestId);
                        if(request) {
                            setActiveTab('search');
                            searchInput.value = request.requestId;
                            handleSearch();
                            const resultEl = document.getElementById('search-results');
                            if(resultEl) {
                                setTimeout(() => {
                                    resultEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                    const card = resultEl.querySelector('div');
                                    if (card) {
                                        card.style.transition = 'all 0.5s ease';
                                        card.style.backgroundColor = '#e0e7ff';
                                        setTimeout(() => { card.style.backgroundColor = ''; }, 2000);
                                    }
                                }, 200);
                            }
                        }
                        const url = new URL(window.location);
                        url.searchParams.delete('requestId');
                        window.history.replaceState({}, '', url);
                        state.deepLinkedRequestId = null;
                    }

                    updateUI();
                    if(state.activeTab === 'search') { handleSearch(); }
                    if(state.activeTab === 'stats' && state.isLoggedIn) { renderStatistics(); }
                    if(state.activeTab === 'stats-dispatch' && state.isLoggedIn) { 
                        if (statsDispatchDateFilter.value && statsDispatchResults.innerHTML !== '<p class="text-center text-gray-500">請選擇日期以產生領料明細。</p>') {
                            renderDispatchList(); 
                        }
                    }
                }, (error) => {
                    console.error("Error listening for requests:", error);
                    showAlert('無法讀取資料庫，請檢查網路連線或重新整理頁面。', '錯誤');
                });
            }

            function handleUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const requestId = urlParams.get('requestId');
                if (requestId) {
                    state.deepLinkedRequestId = requestId;
                }
            }

            async function initFirebase() {
                try {
                    const firebaseConfig = typeof __firebase_config !== 'undefined' 
                        ? JSON.parse(__firebase_config)
                        : {
                            // Fallback for local dev
                            apiKey: "AIzaSyBYKTJ-spvowjo2eIjabifizCwSIP29twM",
                            authDomain: "cch5500-45ed9.firebaseapp.com",
                            projectId: "cch5500-45ed9",
                            storageBucket: "cch5500-45ed9.firebasestorage.app",
                            messagingSenderId: "689704613039",
                            appId: "1:689704613039:web:725556c49988e0b78e105a",
                            measurementId: "G-4XDWW8VFDX"
                        };
                    
                    state.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    state.collectionPath = `artifacts/${state.appId}/public/data/requests`;
                    console.log(`[FirebaseInit] Using collection path: ${state.collectionPath}`);

                    if (!firebaseConfig.apiKey) {
                        showAlert('Firebase 設定不正確，因此無法連接到雲端資料庫。', '資料庫連線失敗');
                        console.error("[FirebaseInit] FAIL: Firebase config is missing or invalid.");
                        submitBtn.disabled = true; submitBtn.textContent = '資料庫未連接'; submitBtn.classList.add('cursor-not-allowed', 'bg-gray-400', 'hover:bg-gray-400'); submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        searchBtn.disabled = true; searchInput.disabled = true; searchInput.placeholder = '資料庫未連接';
                        const adminTabBtn = document.querySelector('button[data-tab="admin"]'); if (adminTabBtn) adminTabBtn.disabled = true;
                        if (statsTabBtn) statsTabBtn.disabled = true;
                         return;
                    }
                    
                    const app = initializeApp(firebaseConfig);
                    state.db = getFirestore(app);
                    state.auth = getAuth(app);
                    
                    setLogLevel('debug');

                    onAuthStateChanged(state.auth, (user) => {
                        if (user) {
                            if (user.isAnonymous) {
                                console.log("[Auth] User is authenticated anonymously (Base Firestore access).");
                            } else {
                                console.log("[Auth] User is authenticated via session. UID:", user.uid);
                                state.isLoggedIn = true; 
                            }
                            console.log("[Auth] Auth state ready. UID:", user.uid);
                            listenForRequests(); // Start listening *after* auth is confirmed
                            updateUI();
                        } else {
                            console.log("[Auth] User is not authenticated (signed out).");
                            state.isLoggedIn = false; 
                            updateUI();
                            signIn();
                        }
                    });

                    async function signIn() {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                console.log("[Auth] Attempting sign-in with custom token...");
                                await signInWithCustomToken(state.auth, __initial_auth_token);
                                console.log("[Auth] SUCCESS: Custom token sign-in successful.");
                            } else {
                                console.log("[Auth] Attempting anonymous sign-in...");
                                await signInAnonymously(state.auth); 
                                console.log("[Auth] SUCCESS: Anonymous sign-in successful.");
                            }
                        } catch (authError) {
                            console.error("[Auth] FATAL ERROR during sign-in:", authError);
                            showAlert('身份驗證失敗，無法連接到資料庫。', '嚴重錯誤');
                        }
                    }

                    await signIn();
                    console.log("[FirebaseInit] Initialization complete.");

                } catch (error) {
                    console.error("[FirebaseInit] FATAL ERROR during initialization:", error);
                    showAlert('系統初始化失敗，請重新整理頁面。', '嚴重錯誤');
                }
            }
            
            // --- ***** MODIFIED: MULTI-ITEM FUNCTIONS ***** ---

           function populateDatalist(datalistElement) {
                if (!datalistElement) return;
                datalistElement.innerHTML = '';
                state.itemDatabase.forEach(item => {
                    const option = document.createElement('option');
                    
                    // *** 變更 ***: 讓選項顯示 "材料編號 - 藥品名稱"
                    // (排除 "其他" 選項)
                    if (item.name === "其他(自行輸入)") {
                        option.value = item.name;
                    } else {
                        // 使用 "ID - Name" 格式
                        option.value = `${item.id} - ${item.name}`; 
                    }
                    datalistElement.appendChild(option);
                });
            }

         function handleItemSelection(event) {
                const searchInput = event.target;
                const row = searchInput.closest('.item-row');
                if (!row) return;

                const materialIdInput = row.querySelector('.material-id-input');
                const itemUnitInput = row.querySelector('.item-unit-input');
                const otherItemContainer = row.querySelector('.item-name-other-container');
                const otherItemInput = row.querySelector('.item-name-other');
                const itemRemarksInput = row.querySelector('.item-remarks-input');

                const value = searchInput.value.trim(); // 這裡可能是 "ID - Name"

                // *** 變更 ***: 更新尋找邏輯
                // 1. 優先比對 "ID - Name" 格式 (當使用者剛從 datalist 選擇時)
                let selectedItem = state.itemDatabase.find(item => 
                    `${item.id} - ${item.name}` === value
                );

                // 2. 如果找不到 (例如使用者點擊一個已經填好 "Name" 的欄位)，則嘗試比對純 Name
                if (!selectedItem) {
                    selectedItem = state.itemDatabase.find(item => item.name === value);
                }

                if (value === "其他(自行輸入)") {
                    // (此邏輯不變)
                    otherItemContainer.classList.remove('hidden');
                    materialIdInput.value = '';
                    itemUnitInput.value = '';
                    materialIdInput.disabled = false;
                    itemUnitInput.disabled = false;
                    itemRemarksInput.disabled = false; 
                    materialIdInput.classList.remove('disabled-input');
                    itemUnitInput.classList.remove('disabled-input');
                    itemRemarksInput.classList.remove('disabled-input'); 
                    otherItemInput.focus();
                } else if (selectedItem) {
                    // (此邏輯是關鍵)
                    otherItemContainer.classList.add('hidden');
                    otherItemInput.value = '';
                    
                    // *** 變更 ***: 
                    // 無論使用者選的是 "ID - Name" 還是 "Name"，都將輸入框的值設回純 "Name"
                    searchInput.value = selectedItem.name; 
                    
                    materialIdInput.value = selectedItem.id;
                    itemUnitInput.value = selectedItem.unit;
                    materialIdInput.disabled = true;
                    itemUnitInput.disabled = true;
                    itemRemarksInput.disabled = false; 
                    materialIdInput.classList.add('disabled-input');
                    itemUnitInput.classList.add('disabled-input');
                    itemRemarksInput.classList.remove('disabled-input'); 
                } else {
                    // (此邏輯不變 - 處理使用者手動輸入非選項內容)
                    otherItemContainer.classList.add('hidden');
                    otherItemInput.value = '';
                    materialIdInput.disabled = false;
                    itemUnitInput.disabled = false;
                    itemRemarksInput.disabled = false; 
                    materialIdInput.classList.remove('disabled-input');
                    itemUnitInput.classList.remove('disabled-input');
                    itemRemarksInput.classList.remove('disabled-input');
                }
            }

            /**
             * Creates and appends a new item row to the form
             * @param {Object | null} itemData - Data to pre-populate the row (used for loading)
             * @param {boolean} disabled - Whether to load the row in a disabled (view-only) state
             */
            function createItemRow(itemData = null, disabled = false) {
                const rowId = state.itemRowCounter++;
                const row = document.createElement('div');
                // ***** MODIFIED: Grid layout for new remarks field *****
                row.className = 'item-row grid grid-cols-1 md:grid-cols-12 gap-x-4 gap-y-4 items-end';
                
                // 1. Item Search (Name)
                row.innerHTML = `
                    <div class="md:col-span-3">
                        <label for="item_name_search_${rowId}" class="block text-sm font-medium text-gray-700">申請藥品 (搜尋)</label>
                        <input type="text" id="item_name_search_${rowId}" list="item-list-${rowId}" class="item-name-search mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                        <datalist id="item-list-${rowId}"></datalist>
                    </div>
                `;
                
                // 2. Other Item Container (Hidden)
                const otherContainer = document.createElement('div');
                otherContainer.id = `item_name_other_container_${rowId}`;
                otherContainer.className = 'item-name-other-container hidden md:col-span-3';
                otherContainer.innerHTML = `
                    <label for="item_name_other_${rowId}" class="block text-sm font-medium text-gray-700">品名 (其他)</label>
                    <input type="text" id="item_name_other_${rowId}" class="item-name-other mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                `;
                row.appendChild(otherContainer);

                // 3. Material ID
                const materialIdDiv = document.createElement('div');
                materialIdDiv.className = 'md:col-span-2';
                materialIdDiv.innerHTML = `
                    <label for="material_id_${rowId}" class="block text-sm font-medium text-gray-700">材料編號</label>
                    <input type="text" id="material_id_${rowId}" class="material-id-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                `;
                row.appendChild(materialIdDiv);
                
                // 4. Unit
                const unitDiv = document.createElement('div');
                unitDiv.className = 'md:col-span-1';
                unitDiv.innerHTML = `
                    <label for="item_unit_${rowId}" class="block text-sm font-medium text-gray-700">單位</label>
                    <input type="text" id="item_unit_${rowId}" class="item-unit-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                `;
                row.appendChild(unitDiv);

                // 5. Quantity
                const quantityDiv = document.createElement('div');
                quantityDiv.className = 'md:col-span-1';
                quantityDiv.innerHTML = `
                    <label for="quantity_${rowId}" class="block text-sm font-medium text-gray-700">数量</label>
                    <input type="text" id="quantity_${rowId}" class="quantity-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="例如: 10">
                `;
                row.appendChild(quantityDiv);

                // ***** NEW 6. Item Remarks *****
                const remarksDiv = document.createElement('div');
                remarksDiv.className = 'md:col-span-4';
                remarksDiv.innerHTML = `
                    <label for="item_remarks_${rowId}" class="block text-sm font-medium text-gray-700">品項備註 (非必填)</label>
                    <input type="text" id="item_remarks_${rowId}" class="item-remarks-input mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="此品項的特殊說明...">
                `;
                row.appendChild(remarksDiv);

                // 7. Remove Button
                const removeBtnDiv = document.createElement('div');
                removeBtnDiv.className = 'md:col-span-1 flex items-end justify-end';
                removeBtnDiv.innerHTML = `
                    <button type="button" title="移除此品項" class="remove-item-btn p-2 text-red-600 hover:text-red-800 hover:bg-red-100 rounded-full">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.578 0h11.218c1.29 0 2.47.63 3.163 1.708m-11.218 0a48.067 48.067 0 01-3.478-.397m12.578 0L12 2.25v3.545m-3.163 1.708L9.5 2.25v5.292" />
                        </svg>
                    </button>
                `;
                row.appendChild(removeBtnDiv);

                itemListContainer.appendChild(row);

                const datalist = row.querySelector(`#item-list-${rowId}`);
                populateDatalist(datalist);

                const searchInput = row.querySelector('.item-name-search');
                searchInput.addEventListener('input', handleItemSelection);
                searchInput.addEventListener('change', handleItemSelection);

                const removeBtn = row.querySelector('.remove-item-btn');
                removeBtn.addEventListener('click', () => {
                    row.remove();
                    if (itemListContainer.children.length === 0) {
                        createItemRow();
                    }
                });
                
                if (itemData) {
                    searchInput.value = itemData.itemName || '';
                    
                    const selectedItem = state.itemDatabase.find(item => item.name === itemData.itemName);
                    if (!selectedItem || itemData.itemName === "其他(自行輸入)") {
                        otherContainer.classList.remove('hidden');
                        otherContainer.querySelector('.item-name-other').value = itemData.itemName;
                        searchInput.value = "其他(自行輸入)";
                    }

                    materialIdDiv.querySelector('.material-id-input').value = itemData.materialId || '';
                    unitDiv.querySelector('.item-unit-input').value = itemData.itemUnit || '';
                    quantityDiv.querySelector('.quantity-input').value = itemData.quantity || '';
                    remarksDiv.querySelector('.item-remarks-input').value = itemData.itemRemarks || ''; // ***** NEW *****
                }
                
                if (disabled) {
                    row.querySelectorAll('input, textarea').forEach(input => {
                        input.disabled = true;
                        input.classList.add('disabled-input');
                    });
                    removeBtn.classList.add('hidden');
                }

                if (itemData) {
                     handleItemSelection({ target: searchInput });
                     if (disabled) {
                         row.querySelectorAll('input, textarea').forEach(input => {
                             input.disabled = true;
                             input.classList.add('disabled-input');
                         });
                     }
                }
            }
            // --- END: MULTI-ITEM FUNCTIONS ---


            // --- EVENT LISTENERS ---
            logoutBtn.addEventListener('click', logout);
            adminLoginPromptBtn.addEventListener('click', promptLogin);
            statsLoginPromptBtn.addEventListener('click', promptLogin);
            exportExcelBtn.addEventListener('click', exportToExcel);
            statsMonthFilter.addEventListener('change', renderStatistics);
            tabButtons.forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));
            clearBtn.addEventListener('click', resetForm);
            searchBtn.addEventListener('click', handleSearch);
            searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleSearch(); });
            adminSearchInput.addEventListener('input', renderAdminList);
            refreshAdminListBtn.addEventListener('click', () => {
                const icon = refreshAdminListBtn.querySelector('svg');
                if (icon) icon.classList.add('animate-spin');
                renderAdminList(); 
                setTimeout(() => { if (icon) icon.classList.remove('animate-spin'); }, 700);
            });
            
            addItemBtn.addEventListener('click', () => createItemRow());

            statsDispatchLoginPromptBtn.addEventListener('click', promptLogin);
            statsDispatchGenerateBtn.addEventListener('click', renderDispatchList);
            statsDispatchSearchInput.addEventListener('input', renderDispatchList);


            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!state.collectionPath) {
                    showAlert('資料庫尚未準備就緒，請稍後再試。', '錯誤');
                    return;
                }
                
                const applicantName = document.getElementById('applicant_name').value;
                if (!applicantName && !state.editingRequestId) {
                    showAlert('請填寫申請人姓名！', '資料不完整'); 
                    document.getElementById('applicant_name').focus();
                    document.getElementById('applicant_name').classList.add('border-red-500', 'animate-shake');
                    setTimeout(() => { document.getElementById('applicant_name').classList.remove('border-red-500', 'animate-shake'); }, 600);
                    return; 
                }

                submitBtn.disabled = true;
                submitBtn.textContent = '處理中...';

                try {
                    if (state.editingRequestId) {
                        // ***** MODIFIED: Handle admin update (now includes item updates) *****
                        
                        let hasError = false;
                        const originalRequest = state.requests.find(r => r.id === state.editingRequestId);
                        const newItems = originalRequest.items ? [...originalRequest.items] : []; // Clone
                        
                        const adminItemRows = adminItemListContainer.querySelectorAll('.item-row-admin');
                        
                        adminItemRows.forEach(row => {
                            const index = parseInt(row.dataset.itemIndex, 10);
                            if (isNaN(index) || !newItems[index]) return; // Safety check

                            const dispatchQtyInput = row.querySelector('.admin-dispatch-qty');
                            const dispatchRemarksInput = row.querySelector('.admin-dispatch-remarks');
                            
                            const dispatchQty = dispatchQtyInput.value;
                            const originalQty = dispatchQtyInput.dataset.originalQty;
                            const dispatchRemarks = dispatchRemarksInput.value;

                            // Reset error style
                            dispatchRemarksInput.classList.remove('border-red-500');

                            // Validation
                            if (dispatchQty !== originalQty && !dispatchRemarks) {
                                hasError = true;
                                dispatchRemarksInput.classList.add('border-red-500');
                                dispatchRemarksInput.focus();
                            }
                            
                            // Update the item in the cloned array
                            newItems[index] = { 
                                ...newItems[index], 
                                dispatchQuantity: dispatchQty, 
                                dispatchRemarks: dispatchRemarks 
                            };
                        });

                        if (hasError) {
                            showAlert('發料數量與申請數量不同時，必須填寫「發料備註」。', '資料不完整');
                            submitBtn.disabled = false;
                            submitBtn.textContent = '更新處理進度';
                            return;
                        }

                        const formData = {
                             items: newItems, // ***** NEW: Save updated items array *****
                             dispatchStatus: document.getElementById('process_status').value, 
                             dispatchMethod: document.getElementById('distribution_method').value,
                             driverName: document.getElementById('issuer_assistant').value, 
                             driverPhone: document.getElementById('verifying_pharmacist').value, 
                             /* 'applicantSignee' 已移除 */
                             adminRemarks: document.getElementById('management_remarks').value, 
                        };
                        const docRef = doc(state.db, state.collectionPath, state.editingRequestId);
                        await updateDoc(docRef, formData);
                        showAlert('申請單已更新！');
                        resetForm();
                        setActiveTab('admin');
                    } else {
                        // Handle new application
                        
                        // ***** MODIFIED: Read all item rows including new remarks *****
                        const items = [];
                        const itemRows = document.querySelectorAll('#item-list-container .item-row');
                        let hasError = false;

                        if (itemRows.length === 0) {
                            showAlert('請至少新增一項申請品項。', '資料不完整');
                            submitBtn.disabled = false;
                            submitBtn.textContent = '提交新申請';
                            return;
                        }

                        itemRows.forEach(row => {
                            const itemNameSearch = row.querySelector('.item-name-search').value;
                            const itemNameOther = row.querySelector('.item-name-other').value;
                            const finalItemName = (itemNameSearch === '其他(自行輸入)') ? itemNameOther : itemNameSearch;
                            
                            const materialId = row.querySelector('.material-id-input').value;
                            const itemUnit = row.querySelector('.item-unit-input').value;
                            const quantity = row.querySelector('.quantity-input').value;
                            const itemRemarks = row.querySelector('.item-remarks-input').value; // ***** NEW *****

                            if (!finalItemName || !quantity) {
                                hasError = true;
                                row.classList.add('border-red-500', 'animate-shake');
                                setTimeout(() => { row.classList.remove('border-red-500', 'animate-shake'); }, 600);
                            }

                            if (finalItemName && quantity) {
                                items.push({
                                    itemName: finalItemName,
                                    materialId: materialId,
                                    itemUnit: itemUnit,
                                    quantity: quantity,
                                    itemRemarks: itemRemarks // ***** NEW *****
                                });
                            }
                        });

                        if (hasError) {
                            showAlert('請填寫所有品項的「名稱/品名」與「數量」。', '資料不完整');
                            submitBtn.disabled = false;
                            submitBtn.textContent = '提交新申請';
                            return;
                        }
                        
                        if (items.length === 0) {
                            showAlert('請至少新增一項有效的申請品項 (需填寫名稱與數量)。', '資料不完整');
                            submitBtn.disabled = false;
                            submitBtn.textContent = '提交新申請';
                            return;
                        }

                        // --- Continue with submission ---
                        const today = new Date();
                        const yyyy = today.getFullYear();
                        const mm = String(today.getMonth() + 1).padStart(2, '0');
                        const datePrefix = `${yyyy}${mm}`;

                        const requestsColRef = collection(state.db, state.collectionPath);
                        const q = query(requestsColRef,
                            where("requestId", ">=", `${datePrefix}-`),
                            where("requestId", "<", `${datePrefix}-~`)
                        );
                        const querySnapshot = await getDocs(q);
                        const newSeq = String(querySnapshot.size + 1).padStart(3, '0');
                        const newRequestId = `${datePrefix}-${newSeq}`;

                        const formData = {
                            requestId: newRequestId,
                            items: items, // ***** MODIFIED: Save items array *****
                            applicantUnit: document.getElementById('applicant_unit').value,
                            costCode: document.getElementById('cost_code').value,
                            applicantName: applicantName,
                            submittedApprover: document.getElementById('approving_manager_name').value, 
                            remarks: document.getElementById('remarks').value,
                            approvingManager: '',
                            managerRemarks: '',
                            dispatchStatus: '待單位主管簽核', 
                            dispatchMethod: '',
                            driverName: '',
                            driverPhone: '',
                            applicantSignee: '',
                            signeeTimestamp: null,
                            adminRemarks: '',
                            createdAt: serverTimestamp()
                         };

                        const newDocRef = await addDoc(requestsColRef, formData);

                        const approvalLink = `${window.location.origin}${window.location.pathname}?requestId=${newDocRef.id}`;
                        showSuccessWithLink('申請已成功送出！請將以下連結傳送給您的主管進行簽核。', approvalLink);

                        resetForm();
                        setActiveTab('search');
                        searchInput.value = formData.applicantName;
                        handleSearch();
                    }
                } catch(error) {
                    console.error("Form submission error: ", error);
                    showAlert('提交失敗，請檢查您的網路連線或資料庫權限設定。', '錯誤');
                    submitBtn.disabled = false;
                    submitBtn.textContent = state.editingRequestId ? '更新處理進度' : '提交新申請';
                }
            });

            // --- KICKSTART THE APP ---
            function init() {
                createItemRow(); // Create the first empty item row on load
                handleUrlParams();
                initFirebase();
                setActiveTab('apply');
                updateUI();
            }
            init();
        });
    </script>
</body>
</html>

